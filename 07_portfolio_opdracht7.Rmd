# Structured Query Language

Structured Query Language (SQL), is a programming language which was creating for communicating with and editing databases. With the increasing usage of cloud storage and databases, the importance of SQL has become higher as the world got more automated. nearly all databases use SQL as their main programming language. Because of the high usage, learning SQL is very relevant. I currently have a basic knowledge of how to use SQL to create a database and to  add, edit and remove data from databases.  On this page, I will demonstrate what I can all do with SQL and build a SQL database. For this, I used two files that contained the number of dengue fever cases and flu cases from 2002 till 2015. Further more, some additional information about the countries was obtained from the gap minder data set, which is available as a R-package. I will make a short analysis of the data sets. The general steps I took in this analysis are: 

- Manual download of the Dengue Fever data set from the [dsfb2 repository](https://github.com/DataScienceILC/tlsc-dsfb26v-20_workflows)

- Manual download of the Flu Fever data set from the [dsfb2 repository](https://github.com/DataScienceILC/tlsc-dsfb26v-20_workflows).

- install the "gapminder" r-package 

- Clean and tidy the data

- Write the data away in the folder data

- Make a SQL database of the data using RPostgreSQL

- join the different data tables in the database 

- download the joined table from the database 

- Visualize the data in graphs 

- if a correlation is suspected, perform descriptive statistics 

- Conclusion

## cleaning data 

After loading in the data, I inspected the data. The data from the gap minder data set is shown in table \@ref(fig:07table1)

The data from the dengue data set is shown in table \@ref(fig:07table2)

The data from the flu data set is shown in table \@ref(fig:07table3)



```{r setup7, warning = FALSE, message = FALSE, echo = FALSE} 
library(RPostgreSQL)
library(gapminder)
library(tidyverse)
library(RPostgres)
library(gridExtra)
library(ggplot2)
library(ggtext)
library(plotly)
library(dslabs)
library(here)
library(DBI)
library(DT)
```

```{r 07 reading in data, warning = FALSE, message = FALSE, echo = FALSE}
dengue <- read.csv(here::here("raw/007_dengue.csv"), skip = 11) #skip 11 is to ignore the meta data at the top

flu <- read.csv(here::here("raw/007_flu.csv"), skip = 11) #skip 11 is to ignore the meta data at the top

gapminder <- read_builtin("gapminder")
```

```{r 07table1,include=TRUE, warning = FALSE, message = FALSE, echo = FALSE, fig.cap= "data from gap minder dataset"}
datatable(gapminder)

```

```{r 07table2, include=TRUE, warning = FALSE, message = FALSE, echo = FALSE, fig.cap= "data from dengue dataset"}
datatable(dengue)

```

```{r 07table3, include=TRUE, warning = FALSE, message = FALSE, echo = FALSE, fig.cap= "data from flu dataset"}

datatable(flu)
```

The gapminder data set was already in tidy data format, and therefor did not need to be edited. The dengue and flu data set did require editing to make the tables tidy. To make later comparisons of the different data sets easier, the format of the flu and dengue data sets were changed to match the format of the gapminder data set. The changes made were: 

- Put all countries in one column, and the cases to one column
- split the column Date to three columns named Year, Month and Day 
- correct data classes 

The new tidy dengue table is shown in table \@ref(fig:07table4)
The new tidy flu table is shown in table \@ref(fig:07table5)

The new tables were stored as a .csv file and as a .rds file in the "[data folder](https://github.com/Arthur1Timmermans/portofolio/tree/main/data)"

```{r 07 tidy data, echo=FALSE, message=FALSE, warning=FALSE}
# tidy the dengue dataset
## Put all countries in one column, and the cases to one column
dengue_tidy <- dengue %>%  pivot_longer(
                                        cols = Argentina:Venezuela,
                                        names_to = "Country",
                                        values_to = "dengue_cases"
                                        )

# split the column Date to three columns named Year, Month and Day
dengue_tidy <- dengue_tidy %>% separate(Date, c("Year", "Month", "Day"))

# correct data classes
dengue_tidy$Year <- as.numeric(dengue_tidy$Year)
dengue_tidy$Month <- as.numeric(dengue_tidy$Month)
dengue_tidy$Day <- as.numeric(dengue_tidy$Day)



# tidy the flu dataset
## Put all countries in one column and the cases in another column
flu_tidy <- flu %>% pivot_longer(
                                cols = Argentina:Uruguay,
                                names_to = "Country",
                                values_to = "flu_cases"
                                )

## split the column Date to three columns named Year, Month and Day
flu_tidy <- flu_tidy %>% separate(Date, c("Year", "Month", "Day"))

## correct data classes
flu_tidy$Year <- as.numeric(flu_tidy$Year)
flu_tidy$Month <- as.numeric(flu_tidy$Month)
flu_tidy$Day <- as.numeric(flu_tidy$Day)
```

```{r 07table4, include=TRUE, warning = FALSE, message = FALSE, echo = FALSE, fig.cap= "tidy data from dengue dataset"}
datatable(dengue_tidy)
```

```{r 07table5, include=TRUE, warning = FALSE, message = FALSE, echo = FALSE, fig.cap= "tidy data from flu dataset"}
datatable(flu_tidy)
```


```{r 07 saving in the desired formats, warning=FALSE, message=FALSE, echo=FALSE}

#all data gets saved to the data folder in a csv file
flu_tidy %>% write.csv(file = "./data/flu_tidy.csv")
dengue_tidy %>% write.csv(file = "./data/dengue_tidy.csv")
gapminder %>% write.csv(file = "./data/gapminder.csv")

# all data also gets saved to the data folder in a RDS file
saveRDS(gapminder, file = "./data/gapminder.rds")
saveRDS(dengue_tidy, file = "./data/dengue_tidy.rds")
saveRDS(flu_tidy, file = "./data/flu_tidy.rds")
```

## setting up a database 

### exporting data to DBeaver

The program "[DBeaver](https://dbeaver.io/)" was used to set up and maintain a database for this project. The new tidy data files were exporting to DBeaver using Rpostgres. This is further shown in the code chunk bellow. 

```{r 07 export data to DBeaver, eval=FALSE, echo=TRUE, warning=FALSE, message=FALSE}
# the link to exporting files to DBeaver requires to fill in personal information such as a  password, which is unique for all users. 
# this analysis is reproducible if you copy the code and insert your own local information. 

con <- dbConnect(RPostgres::Postgres(),
                 dbname = "workflowsdb",
                 host = "localhost",
                 port = "5432",
                 user = "postgres",
                 password = "231mm1AM!")
dbWriteTable(con, "flu_tidy", flu_tidy)
dbWriteTable(con, "dengue_tidy", dengue_tidy)
dbWriteTable(con, "gapminder", gapminder)

dbListTables(con)

dbDisconnect(con)

```

After checking both in R using the "dbListTables(con)" funcion, and in DBeaver, it was confimred that the data was imported properly. This can also be seen in the image bellow. 

![inspecting if data was loaded into DBEAVER](images/DB1.png)


### SQL script 
In D beaver, the following script is written to further inspect the data. All used SQL scripts can also be found [here]

---------------------------------------------------------------------------------------------------------------------
SELECT dengue_cases, country 
FROM dengue_tidy order 
BY dengue_cases asc

SELECT flu_cases, country 
FROM flu_tidy order 
BY flu_cases asc

SELECT population, country 
FROM gapminder order 
BY population desc
---------------------------------------------------------------------------------------------------------------------

The images bellow further show the data loaded into DBeaver: 

![inspecting if dengue fever data was loaded into DBEAVER](images/DBD1.png)

![inspecting if flu data was loaded into DBEAVER](images/DBF1.png)

![inspecting if gapminder data was loaded into DBEAVER](images/DBG1.png)


After inspected the data in Dbeaver, the data was also still inspected in R using the dplyr package. Bellow the data from the dengue, flu and gapminder data set are shown respectively. It becomes visible that, the data in these tables are the same as the data that was loaded into DBeaver. This confirms that the data was exported properly. 

```{r 07 visualizing  data sets with dplyr, include=TRUE, warning = FALSE, message = FALSE, echo = FALSE}
dplyr::tbl_df(dengue_tidy)

dplyr::tbl_df(flu_tidy)

dplyr::tbl_df(gapminder)
```

The file from the gapminder dataset still contained a lot of additional information from additional years, that was not included in the flu and dengue fever data set. Therefor, table \@ref(fig:07table6) was created. In this table only the years 2002 - 2015 were selected. This new tidy data file from the gapminder data set was also exported to DBeaver using Rpostgres. 

```{r creating tidy gapminder table,  warning=FALSE, message=FALSE, echo=FALSE}
gapminder_tidy <- gapminder[between(gapminder$year, 2002, 2015), ] #filter the years of the flu/dengue fever data set 

gapminder_tidy <- gapminder_tidy %>% select(year, country, infant_mortality:region) # change the order to year, country. This is the same order as in the flu/dengue fever data set 


```

```{r 07 export data to DBeaver, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
dbWriteTable(con, "gapminder_tidy", gapminder_tidy) # exporting the new gapminder table to DBeaver. 
```

```{r 07table6, include=TRUE, warning = FALSE, message = FALSE, echo = FALSE, fig.cap= "tidy data from gapminder dataset"}
datatable(gapminder_tidy)
``` 
 

### importing data from DBeaver 

after exporting the data from Rstudio to DBeaver, the data was imported back from DBeaver to Rstudio with the following script: 

```{r 07 import data from dbeaver, eval=FALSE, echo=TRUE}
# import the data into R after inspecting the data in DBeaver
gapminder <- dbReadTable(con, "gapminder")
dengue <- dbReadTable(con, "dengue_tidy")
flu <- dbReadTable(con, "flu_tidy")
```

## data visualization 

The data will now be visualized to check if the flu or dengue fever is more prevalent in certain areas.

The data from the flu dataset is shown in figure \@ref(fig:07graph1)

The data from the dengue  dataset is shown in figure \@ref(fig:07graph2)

```{r 07graph1, message=FALSE, warning=FALSE, echo=FALSE, fig.cap= "first graph from flu dataset, sorted by country"}
#clean variables names
flu_tidy <- janitor::clean_names(flu_tidy)

flu_1 <- flu_tidy %>% group_by(year) %>% na.omit() %>% 
  ggplot(aes(x = year,
             y = flu_cases,
             fill = year)) +
  geom_col() +
  theme(axis.text.x = element_text(angle = 90))+
  labs(title = "Evaluating the number of flu cases",
       subtitle = "Have flu cases risen over the years?",
       x = "Year",
       y = "Number of flu cases",
       caption = "Data source: Course instructors") 


## Check per country
flu_1 + facet_wrap(~country)
```

```{r 07graph2, message=FALSE, warning=FALSE, echo=FALSE, fig.cap= "first graph from dengue dataset, sorted by country"}
#clean variables names
dengue_tidy <- janitor::clean_names(dengue_tidy)

dengue_1 <- dengue_tidy %>% group_by(year) %>% na.omit() %>% 
  ggplot(aes(x = year,
             y = dengue_cases,
             fill = year)) +
  geom_col() +
  theme(axis.text.x = element_text(angle = 90))+
  labs(title = "Evaluating the number of flu cases",
       subtitle = "Have flu cases risen over the years?",
       x = "Year",
       y = "Number of flu cases",
       caption = "Data source: Course instructors")

## let's see the difference between countries
dengue_1 + facet_grid(~country)

```

## Conclusions on the flu dataset

When considering the number of **flu** cases globally as shown in figure \@ref(fig:07graph1), it becomes visible that the highest occurrence of the flu is in Spain, followed by Canada and the United States. The lowest flu occurrences on the other hand are found in Sweden, followed by Chile and New Zealand.
The reason for this is partciular spread of flu cases is unknown. To establish significance it's possible to still run additional statistical testing, and to possibly research more metadata. 

## Conclusions on the dengue dataset
When looking at figure \@ref(fig:07graph2), it's visible that the highest number of **dengue** cases are seen in Venezuele, followed by Indonesia and Brazil. Dengue fever develops after infection with the Flaviviridae virus carried by mosquitoes. These mosquitoes are more prevalent in countries with warmer climates, which might explain the spread of occurrences that is vissible within the graph.

## joining graphs 
To be able to better compare the two occurances of flu and dengue fever, the 2 plots will be joined together as is shown in figure \@ref(fig:07graph3)

```{r 07 join, message=FALSE, warning=FALSE, echo=FALSE}
flu_dengue <- full_join(flu_tidy, 
                        dengue_tidy, 
                        by = c("country", "year"), 
                        suffix = c("_flu", "_dengue"))

## let's also join the data from the gapminder dataset with the flu and dengue dataset
gapminder_flu_dengue <- inner_join(flu_dengue, 
                                   gapminder, 
                                   by = c("country", 
                                          "year"))

```



```{r 07 Visualize the cases of flu per country, message=FALSE, warning=FALSE, echo=FALSE}
# plot occurrences of flu and dengue per region
flu_country <- gapminder_flu_dengue %>% 
              ggplot() + 
              geom_col(aes(x = country, 
                           y = flu_cases,
                           fill = country)) +
  theme_minimal()  +
  #turn the x axis labels by a 90 degree angle
  theme(axis.text.x = element_text(angle = 90, 
                                   hjust = 1),
        #legend is unnecessary
        legend.position = "none"
        ) + 
  #Explain the graph
  labs(title = "Flu cases per country", 
       x = "",
       y = "Flu cases")

```


```{r 07 Visualize the cases of dengue fever per country, message=FALSE, warning=FALSE, echo=FALSE}
dengue_country <- gapminder_flu_dengue %>% 
                  ggplot() + 
                  geom_col(aes(x = country, 
                               y = dengue_cases,
                               fill = country)) +
                  theme_bw() +
  
                  #turn the x axis label 90 degrees
                  theme(axis.text.x = element_text(angle = 90, 
                                     hjust = 1),
                        legend.position = "none") + 
  
                  #explain the graph
                  labs(title = "Cases of Dengue Fever per country", 
                       x = "",
                       y = "Cases of Dengue Fever")
```

```{r 07graph3, message=FALSE, warning=FALSE, full.width=TRUE, echo=FALSE, fig.cap="flu and dengue fever graphs joined together"}
grid.arrange(flu_country, dengue_country, nrow = 1)
```


## Conclusions after joining
Joining the data set provides us with a singular object that contains data on all three diseases. This helps put things in perspective, however in figure \@ref(fig:07graph1), \@ref(fig:07graph2) and \@ref(fig:07graph3), the conclusions previously drawn remains the same.
